<script context="module"></script>

<script>import Blocks from "../../components/blocks/blocks.svelte";
import { getSizesForBreakpoints } from "../../constants/device-sizes.js";
import InlinedStyles from "../../components/inlined-styles.svelte";
import { TARGET } from "../../constants/target.js";
import "../../functions/deopt.js";
export let js;
export let space = undefined;
export let columns = undefined;
export let stackColumnsAt = undefined;
export let reverseColumnsWhenStacked = undefined;
export let builderContext;
export let builderBlock;
export let builderComponents;
function mitosis_styling(node, vars) {
    Object.entries(vars || {}).forEach(([p, v]) => {
        if (p.startsWith("--")) {
            node.style.setProperty(p, v);
        }
        else {
            node.style[p] = v;
        }
    });
}
function getWidth(index) {
    return cols[index]?.width || 100 / cols.length;
}
function getColumnCssWidth(index) {
    const subtractWidth = (gutterSize * (cols.length - 1)) / cols.length;
    return `calc(${getWidth(index)}% - ${subtractWidth}px)`;
}
function getTabletStyle({ stackedStyle, desktopStyle, }) {
    return stackAt === "tablet" ? stackedStyle : desktopStyle;
}
function getMobileStyle({ stackedStyle, desktopStyle, }) {
    return stackAt === "never" ? desktopStyle : stackedStyle;
}
function columnCssVars(index) {
    const gutter = index === 0 ? 0 : gutterSize;
    const width = getColumnCssWidth(index);
    const gutterPixels = `${gutter}px`;
    const mobileWidth = "100%";
    const mobileMarginLeft = 0;
    const marginLeftKey = "margin-left";
    return {
        width,
        [marginLeftKey]: gutterPixels,
        "--column-width-mobile": getMobileStyle({
            stackedStyle: mobileWidth,
            desktopStyle: width,
        }),
        "--column-margin-left-mobile": getMobileStyle({
            stackedStyle: mobileMarginLeft,
            desktopStyle: gutterPixels,
        }),
        "--column-width-tablet": getTabletStyle({
            stackedStyle: mobileWidth,
            desktopStyle: width,
        }),
        "--column-margin-left-tablet": getTabletStyle({
            stackedStyle: mobileMarginLeft,
            desktopStyle: gutterPixels,
        }),
    };
}
function getWidthForBreakpointSize(size) {
    const breakpointSizes = getSizesForBreakpoints($builderContext.content?.meta?.breakpoints || {});
    return breakpointSizes[size].max;
}
$: columnsCssVars = () => {
    return {
        "--flex-dir": flexDir,
        "--flex-dir-tablet": getTabletStyle({
            stackedStyle: flexDir,
            desktopStyle: "row",
        }),
    };
};
$: columnsStyles = () => {
    return `
        @media (max-width: ${getWidthForBreakpointSize("medium")}px) {
          .${builderBlock.id}-breakpoints {
            flex-direction: var(--flex-dir-tablet);
            align-items: stretch;
          }

          .${builderBlock.id}-breakpoints > .builder-column {
            width: var(--column-width-tablet) !important;
            margin-left: var(--column-margin-left-tablet) !important;
          }
        }

        @media (max-width: ${getWidthForBreakpointSize("small")}px) {
          .${builderBlock.id}-breakpoints {
            flex-direction: var(--flex-dir);
            align-items: stretch;
          }

          .${builderBlock.id}-breakpoints > .builder-column {
            width: var(--column-width-mobile) !important;
            margin-left: var(--column-margin-left-mobile) !important;
          }
        },
      `;
};
let gutterSize = typeof space === "number" ? space || 0 : 20;
let cols = columns || [];
let stackAt = stackColumnsAt || "tablet";
let flexDir = stackColumnsAt === "never"
    ? "row"
    : reverseColumnsWhenStacked
        ? "column-reverse"
        : "column";
</script>

<div
  use:mitosis_styling={columnsCssVars()}
  class={`builder-columns ${builderBlock.id}-breakpoints` + " div"}
  {...{}}
>
  {#if TARGET !== "reactNative"}
    <InlinedStyles styles={columnsStyles()} />
  {/if}

  {#each columns as column, index (index)}
    <div
      use:mitosis_styling={columnCssVars(index)}
      class="builder-column div-2"
      {...{}}
    >
      <Blocks
        path={`component.options.columns.${index}.blocks`}
        parent={builderBlock.id}
        styleProp={{
          flexGrow: "1",
        }}
        context={builderContext}
        registeredComponents={builderComponents}
        blocks={column.blocks}
      />
    </div>
  {/each}
</div>

<style>
  .div {
    display: flex;
    line-height: normal;
  }
  .div-2 {
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
</style>